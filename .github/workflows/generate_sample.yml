name: Generate the sample project

on:
  push:
    branches:
      - develop

jobs:
  generate_sample_project:
    # Run on merge commits only
    if: ${{ contains(github.event.head_commit.message, 'Merge pull request') || (github.event.head_commit.author.email != 'bot@nimblehq.co') }}
    name: Generate the sample project
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Check out
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.WIKI_ACTION_TOKEN }}

      - name: Set up Flutter environment
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          flutter-version: '3.10.5'

      - name: Remove the old sample project
        run: |
          rm -rf sample

      - name: Set the project name "sample"
        uses: jossef/action-set-json-field@v2.1
        with:
          file: mason-config.json
          field: project_name
          value: sample

      - name: Generate the new sample project
        run: |
          dart pub global activate mason_cli
          mason get
          mason make template -c mason-config.json

      - id: changes
        name: Check for changes in the sample project
        run: |
          count=$(git status sample --porcelain | wc -l)
          echo "count=$count" >> $GITHUB_OUTPUT

      - name: Commit & push the sample project changes
        if: steps.changes.outputs.count > 0
        run: |
          git config user.name team-nimblehq
          git config user.email bot@nimblehq.co
          git add sample
          git commit -m "[Chore] Generate & update sample project"
          git push
